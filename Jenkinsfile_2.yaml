pipeline {
    agent {
        label 'ubuntu-latest'
        docker {
            image 'alugaai-app'
            args '-p 8000:8000'
        }
    }
    environment {
        DJANGO_SETTINGS_MODULE = 'aluga_ai_web.settings'
        PYTHONPATH = "${env.WORKSPACE}"
    }
    stages {
        stage('Executar Migrações do Banco') {
            steps {
                sh 'python manage.py migrate --noinput'
            }
        }
        stage('Executar Job de Validação') {
            steps {
                sh 'python jobs/validate_recommendation_system.py'
            }
        }
        stage('Upload dos Resultados') {
            steps {
                archiveArtifacts artifacts: 'validation_results.json', onlyIfSuccessful: true
            }
        }
        stage('Exibir Resultados') {
            steps {
                sh '''
                if [ -f validation_results.json ]; then
                  echo "=== RESULTADOS DA VALIDAÇÃO ==="
                  cat validation_results.json
                else
                  echo "Arquivo de resultados não encontrado"
                fi
                '''
            }
        }
    }
    post {
        always {
            echo 'Pipeline finalizada.'
        }
    }
}