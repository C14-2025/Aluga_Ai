{% extends "base.html" %}
{% block content %}
<h1>Recomendações Personalizadas</h1>
<p>Informe seu orçamento e filtros opcionais para obter recomendações.</p>
<form id="recoForm">
  {% csrf_token %}
  <div>
    <label>Orçamento (R$): <input type="number" step="0.01" name="budget" required /></label>
  </div>
  <div>
    <label>Cidade: <input type="text" name="city" placeholder="Opcional" /></label>
  </div>
  <fieldset style="margin-top:8px;">
    <legend>Filtros opcionais</legend>
    <div>
      <label>Tipo:
        <select name="property_type">
          <option value="">(Qualquer)</option>
          <option value="apartment">Apartamento</option>
          <option value="studio">Studio</option>
          <option value="house">Casa</option>
          <option value="kitnet">Kitnet</option>
        </select>
      </label>
    </div>
    <div>
      <label>Bairro: <input type="text" name="neighborhood" placeholder="Opcional" /></label>
    </div>
    <div>
      <label>Preço mínimo (R$): <input type="number" step="0.01" min="0" name="min_price" /></label>
    </div>
    <div>
      <label>Preço máximo (R$): <input type="number" step="0.01" min="0" name="max_price" /></label>
    </div>
    <fieldset style="margin-top:8px;">
      <legend>Amenidades</legend>
      <label><input type="checkbox" name="amenities" value="wifi" /> Wi‑Fi</label>
      <label><input type="checkbox" name="amenities" value="piscina" /> Piscina</label>
      <label><input type="checkbox" name="amenities" value="tv" /> TV</label>
      <label><input type="checkbox" name="amenities" value="lavadora" /> Máquina de lavar</label>
      <label><input type="checkbox" name="amenities" value="ar" /> Ar-condicionado</label>
      <label><input type="checkbox" name="amenities" value="cozinha" /> Cozinha equipada</label>
      <label><input type="checkbox" name="amenities" value="estacionamento" /> Estacionamento</label>
      <label><input type="checkbox" name="amenities" value="pet" /> Aceita pets</label>
      <label><input type="checkbox" name="amenities" value="churrasqueira" /> Churrasqueira</label>
    </fieldset>
    <div>
      <label>Área mínima (m²): <input type="number" step="1" min="0" name="min_area" /></label>
    </div>
    <div>
      <label>Área máxima (m²): <input type="number" step="1" min="0" name="max_area" /></label>
    </div>
    <div>
      <label>Quartos: <input type="number" step="1" min="0" name="bedrooms" /></label>
    </div>
    <div>
      <label>Banheiros: <input type="number" step="1" min="0" name="bathrooms" /></label>
    </div>
    <div>
      <label>Vagas: <input type="number" step="1" min="0" name="parking" /></label>
    </div>
  </fieldset>
  <div>
    <label>Limite de itens: <input type="number" name="limit" value="10" min="1" max="50" /></label>
  </div>
  <button type="submit">Buscar Recomendações</button>
</form>
<hr />
<table id="results" style="display:none; width:100%; border-collapse:collapse;">
  <thead>
    <tr>
      <th>ID</th>
      <th>Título</th>
      <th>Cidade</th>
      <th>Preço Previsto</th>
      <th>Score</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<p id="empty" style="display:none;">Nenhuma recomendação retornada.</p>
<script>
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

const form = document.getElementById('recoForm');
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = new FormData(form);
  const payload = {
    budget: parseFloat(data.get('budget')),
    city: data.get('city') || undefined,
    neighborhood: data.get('neighborhood') || undefined,
    limit: parseInt(data.get('limit') || '10', 10)
  };
  const maybeNum = k => {
    const v = data.get(k);
    if (v === null || v === '') return undefined;
    const n = Number(v);
    return Number.isFinite(n) ? n : undefined;
  };
  Object.assign(payload, {
    property_type: data.get('property_type') || undefined,
    min_area: maybeNum('min_area'),
    max_area: maybeNum('max_area'),
    bedrooms: maybeNum('bedrooms'),
    bathrooms: maybeNum('bathrooms'),
    parking: maybeNum('parking'),
    min_price: maybeNum('min_price'),
    max_price: maybeNum('max_price'),
  });
  // coletar amenidades múltiplas
  payload.amenities = Array.from(document.querySelectorAll('input[name="amenities"]:checked')).map(x => x.value);
  try {
    const resp = await fetch('/api/ml/survey_recommend/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken') || ''
      },
      body: JSON.stringify(payload)
    });
    if (!resp.ok) {
      alert('Erro na requisição: ' + resp.status);
      return;
    }
    const items = await resp.json();
    const table = document.getElementById('results');
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    if (items.length === 0) {
      table.style.display = 'none';
      document.getElementById('empty').style.display = 'block';
      return;
    }
    document.getElementById('empty').style.display = 'none';
    table.style.display = 'table';
    items.forEach(it => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${it.id}</td><td>${it.title}</td><td>${it.city}</td><td>R$ ${it.predicted_price.toFixed(2)}</td><td>${it.score.toFixed(4)}</td>`;
      tbody.appendChild(tr);
    });
  } catch (err) {
    alert('Falha: ' + err);
  }
});
</script>
{% endblock %}
