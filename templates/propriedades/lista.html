{% extends 'base.html' %} {% block content %}
<div class="page-header" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
  <h1 style="margin:0;">Home</h1>
  <div>
    {% if user.is_authenticated %}
      <a class="btn btn-primary" href="{% url 'propriedades:nova' %}">Anunciar Imóvel</a>
    {% else %}
      <a class="btn btn-primary" href="{% url 'usuarios:login' %}?next={% url 'propriedades:nova' %}">Anunciar Imóvel</a>
    {% endif %}
  </div>
</div>

<div class="tabs" style="margin-top:16px; display:flex; gap:8px;">
  <button type="button" class="tab-btn active" data-tab="lista">Imóveis</button>
  {% if recomendadas %}<button type="button" class="tab-btn" data-tab="reco">Recomendados</button>{% endif %}
</div>

<details style="margin:16px 0;" open>
  <summary style="cursor:pointer; font-weight:600;">Filtros</summary>
  <form id="filtrosForm" method="get" style="margin-top:12px; display:flex; gap:16px; flex-wrap:wrap; align-items:flex-end;">
    <label style="font-size:12px; font-weight:600;">Título<br>
      <input type="text" name="q" placeholder="Buscar por título..." value="{{ request.GET.q }}" />
    </label>
    <label style="font-size:12px; font-weight:600;">Cidade<br>
      <input type="text" name="city" value="{{ request.GET.city }}" />
    </label>
    <label style="font-size:12px; font-weight:600;">Bairro<br>
      <input type="text" name="neighborhood" value="{{ request.GET.neighborhood }}" />
    </label>
    <label style="font-size:12px; font-weight:600;">Tipo<br>
      <select name="property_type">
        <option value="">(Qualquer)</option>
        <option value="apartment" {% if request.GET.property_type == 'apartment' %}selected{% endif %}>Apartamento</option>
        <option value="studio" {% if request.GET.property_type == 'studio' %}selected{% endif %}>Studio</option>
        <option value="house" {% if request.GET.property_type == 'house' %}selected{% endif %}>Casa</option>
        <option value="kitnet" {% if request.GET.property_type == 'kitnet' %}selected{% endif %}>Kitnet</option>
      </select>
    </label>
    <label style="font-size:12px; font-weight:600;">Área mín (m²)<br>
      <input type="number" step="1" min="0" name="min_area" value="{{ request.GET.min_area }}" />
    </label>
    <label style="font-size:12px; font-weight:600;">Área máx (m²)<br>
      <input type="number" step="1" min="0" name="max_area" value="{{ request.GET.max_area }}" />
    </label>
    <label style="font-size:12px; font-weight:600;">Quartos<br>
      <input type="number" step="1" min="0" name="bedrooms" value="{{ request.GET.bedrooms }}" />
    </label>
    <label style="font-size:12px; font-weight:600;">Banheiros<br>
      <input type="number" step="1" min="0" name="bathrooms" value="{{ request.GET.bathrooms }}" />
    </label>
    <label style="font-size:12px; font-weight:600;">Vagas<br>
      <input type="number" step="1" min="0" name="parking" value="{{ request.GET.parking }}" />
    </label>
    <label style="font-size:12px; font-weight:600;">Preço mín (R$)<br>
      <input type="number" step="0.01" min="0" name="min_price" value="{{ request.GET.min_price }}" />
    </label>
    <label style="font-size:12px; font-weight:600;">Preço máx (R$)<br>
      <input type="number" step="0.01" min="0" name="max_price" value="{{ request.GET.max_price }}" />
    </label>
    <fieldset style="margin-top:8px; min-width:240px;">
      <legend style="font-size:12px; font-weight:600;">Amenidades</legend>
      <label><input type="checkbox" name="amenities" value="wifi" {% if 'wifi' in selected_amenities %}checked{% endif %}/> Wi‑Fi</label>
      <label><input type="checkbox" name="amenities" value="piscina" {% if 'piscina' in selected_amenities %}checked{% endif %}/> Piscina</label>
      <label><input type="checkbox" name="amenities" value="tv" {% if 'tv' in selected_amenities %}checked{% endif %}/> TV</label>
      <label><input type="checkbox" name="amenities" value="lavadora" {% if 'lavadora' in selected_amenities %}checked{% endif %}/> Máquina de lavar</label>
      <label><input type="checkbox" name="amenities" value="ar" {% if 'ar' in selected_amenities %}checked{% endif %}/> Ar‑condicionado</label>
      <label><input type="checkbox" name="amenities" value="cozinha" {% if 'cozinha' in selected_amenities %}checked{% endif %}/> Cozinha equipada</label>
      <label><input type="checkbox" name="amenities" value="estacionamento" {% if 'estacionamento' in selected_amenities %}checked{% endif %}/> Estacionamento</label>
      <label><input type="checkbox" name="amenities" value="pet" {% if 'pet' in selected_amenities %}checked{% endif %}/> Aceita pets</label>
      <label><input type="checkbox" name="amenities" value="churrasqueira" {% if 'churrasqueira' in selected_amenities %}checked{% endif %}/> Churrasqueira</label>
    </fieldset>
    <div style="display:flex; gap:8px; margin-top:8px;">
      <button class="btn btn-secondary" type="submit">Aplicar filtros</button>
      <button type="button" id="btnAuto" class="btn">Auto</button>
    </div>
  </form>
</details>

<div id="tab-lista" class="tab-pane active">
  <div class="cards">
    {% for p in propriedades %}
      <div class="card">
        <h3><a href="{% url 'propriedades:detalhe' p.pk %}">{{ p.titulo }}</a></h3>
        <p>{{ p.descricao|truncatechars:120 }}</p>
        <p class="muted">Preço por noite: R$ {{ p.preco_por_noite }}</p>
        {% if user.is_authenticated %}
          <button class="btn btn-sm" data-fav="{{ p.id }}" data-state="{% if p.is_favorito %}on{% else %}off{% endif %}">
            {% if p.is_favorito %}★ Favorito{% else %}☆ Favoritar{% endif %}
          </button>
        {% endif %}
      </div>
    {% empty %}
      <p>Nenhuma propriedade encontrada com estes filtros.</p>
    {% endfor %}
  </div>
</div>

<div id="tab-reco" class="tab-pane" style="display:none;">
  {% if recomendadas %}
    <h2 style="margin:8px 0 12px;">Recomendados para você</h2>
    <div class="cards">
      {% for item in recomendadas %}
        <div class="card">
          <h3><a href="{% url 'propriedades:detalhe' item.prop.pk %}">{{ item.prop.titulo }}</a></h3>
          <p>{{ item.prop.descricao|truncatechars:120 }}</p>
          <p class="muted">Score: {{ item.score }} | Preço estimado: R$ {{ item.predicted_price|floatformat:2 }}</p>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p>Ainda não há recomendações. Favorite alguns imóveis para gerar recomendações.</p>
  {% endif %}
</div>

<script>
function getCookie(name){const value=`; ${document.cookie}`;const parts=value.split(`; ${name}=`);if(parts.length===2)return parts.pop().split(';').shift();}
// Tabs
document.querySelectorAll('.tab-btn').forEach(btn=>{btn.addEventListener('click',()=>{const tab=btn.dataset.tab;document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');document.querySelectorAll('.tab-pane').forEach(p=>p.style.display='none');document.getElementById('tab-'+tab).style.display='block';});});
// Auto submit filters
const filtrosForm=document.getElementById('filtrosForm');const btnAuto=document.getElementById('btnAuto');let auto=false;let debounce;
if(filtrosForm&&btnAuto){btnAuto.addEventListener('click',()=>{auto=!auto;btnAuto.classList.toggle('btn-primary',auto);if(auto)filtrosForm.submit();});filtrosForm.addEventListener('input',()=>{if(!auto)return;clearTimeout(debounce);debounce=setTimeout(()=>filtrosForm.submit(),350);});}
// Favoritar
document.querySelectorAll('button[data-fav]').forEach(btn=>{btn.addEventListener('click',async()=>{const id=btn.getAttribute('data-fav');const state=btn.getAttribute('data-state');const url= state==='on'? `/favoritos/remove/${id}/`:`/favoritos/add/${id}/`;try{const resp=await fetch(url,{method:'POST',headers:{'X-CSRFToken':getCookie('csrftoken')||''}});if(!resp.ok)return;const data=await resp.json();if(data.favorited){btn.setAttribute('data-state','on');btn.innerHTML='★ Favorito';}else{btn.setAttribute('data-state','off');btn.innerHTML='☆ Favoritar';}
// Se gerou novas recomendações, mostrar aba de recomendações
if(data.recommendations && Array.isArray(data.recommendations)){window.location.reload();}
}catch(e){console.error(e);}});});
</script>
{% endblock %}
